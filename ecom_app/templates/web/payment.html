{% extends 'web/base.html' %}
{% load static %}
{% block content %}

    <!-- PAYMENT PAGE (Flipkart-style layout, White + Brown theme) -->
    <section class="bg-white">
        <div class="px-6 sm:px-10 lg:px-16 py-10 sm:py-14">
            <div class="max-w-7xl mx-auto">

                <!-- Title -->
                <div class="flex items-end justify-between gap-4">
                    <div>
                        <div class="text-sm sm:text-lg text-brownMain font-medium">Payment</div>
                        <h1 class="mt-2 text-3xl sm:text-5xl font-[500] leading-[1.1] tracking-[-0.02em]"
                            style="font-family:'Cormorant Garamond', serif;">
                            Choose a payment method
                        </h1>
                        <p class="mt-3 text-zinc-700 max-w-2xl">
                            Secure payments with UPI, cards, net banking, wallet, or cash on delivery.
                        </p>
                    </div>

                    <a href="{% url 'web:check_out' %}"
                        class="hidden sm:inline-flex items-center gap-2 rounded-xl border border-brownMain text-brownMain px-4 py-2 text-sm font-semibold hover:bg-soft transition">
                        Back to Checkout
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 18l-6-6 6-6" />
                        </svg>
                    </a>
                </div>

                <div class="mt-8 grid gap-8 lg:grid-cols-12 items-start">

                    <!-- LEFT: Payment methods (Tabs + content) -->
                    <div class="lg:col-span-8">

                        <div class="rounded-3xl border border-line bg-white overflow-hidden">
                            <div class="grid md:grid-cols-12">

                                <!-- Left vertical tabs -->
                                <div class="md:col-span-4 border-b md:border-b-0 md:border-r border-line bg-soft">
                                    <button
                                        class="payTab w-full text-left px-5 py-4 border-b border-line hover:bg-white transition flex items-center gap-3"
                                        data-target="tabUPI" aria-selected="true">
                                        <span
                                            class="h-9 w-9 rounded-2xl bg-white border border-line grid place-items-center">
                                            <!-- UPI icon -->
                                            <svg class="h-5 w-5 text-brownMain" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2">
                                                <path d="M7 7h10M9 7v10a3 3 0 0 0 6 0V7" />
                                                <path d="M7 17h10" />
                                            </svg>
                                        </span>
                                        <div>
                                            <div class="text-sm font-semibold text-zinc-900">UPI</div>
                                            <div class="text-xs text-zinc-500">Pay via UPI apps</div>
                                        </div>
                                    </button>

                                    <button
                                        class="payTab w-full text-left px-5 py-4 border-b border-line hover:bg-white transition flex items-center gap-3"
                                        data-target="tabCard">
                                        <span
                                            class="h-9 w-9 rounded-2xl bg-white border border-line grid place-items-center">
                                            <!-- Card icon -->
                                            <svg class="h-5 w-5 text-brownMain" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2">
                                                <rect x="3" y="5" width="18" height="14" rx="2" />
                                                <path d="M3 10h18" />
                                            </svg>
                                        </span>
                                        <div>
                                            <div class="text-sm font-semibold text-zinc-900">Credit / Debit Card</div>
                                            <div class="text-xs text-zinc-500">Visa, MasterCard, RuPay</div>
                                        </div>
                                    </button>

                                    <button
                                        class="payTab w-full text-left px-5 py-4 border-b border-line hover:bg-white transition flex items-center gap-3"
                                        data-target="tabNetbanking">
                                        <span
                                            class="h-9 w-9 rounded-2xl bg-white border border-line grid place-items-center">
                                            <!-- Bank icon -->
                                            <svg class="h-5 w-5 text-brownMain" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2">
                                                <path d="M3 10h18" />
                                                <path d="M4 10V8l8-4 8 4v2" />
                                                <path d="M6 10v9M10 10v9M14 10v9M18 10v9" />
                                                <path d="M4 19h16" />
                                            </svg>
                                        </span>
                                        <div>
                                            <div class="text-sm font-semibold text-zinc-900">Net Banking</div>
                                            <div class="text-xs text-zinc-500">All major banks</div>
                                        </div>
                                    </button>

                                    <button
                                        class="payTab w-full text-left px-5 py-4 border-b border-line hover:bg-white transition flex items-center gap-3"
                                        data-target="tabWallet">
                                        <span
                                            class="h-9 w-9 rounded-2xl bg-white border border-line grid place-items-center">
                                            <!-- Wallet icon -->
                                            <svg class="h-5 w-5 text-brownMain" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2">
                                                <path d="M3 7h18v12H3z" />
                                                <path d="M3 10h12" />
                                                <path d="M17 13h2" />
                                            </svg>
                                        </span>
                                        <div>
                                            <div class="text-sm font-semibold text-zinc-900">Wallet</div>
                                            <div class="text-xs text-zinc-500">Paytm, PhonePe, etc.</div>
                                        </div>
                                    </button>

                                    <button
                                        class="payTab w-full text-left px-5 py-4 hover:bg-white transition flex items-center gap-3"
                                        data-target="tabCOD">
                                        <span
                                            class="h-9 w-9 rounded-2xl bg-white border border-line grid place-items-center">
                                            <!-- COD icon -->
                                            <svg class="h-5 w-5 text-brownMain" viewBox="0 0 24 24" fill="none"
                                                stroke="currentColor" stroke-width="2">
                                                <path d="M12 1v22" />
                                                <path d="M17 5H9.5a3.5 3.5 0 1 0 0 7H14a3.5 3.5 0 1 1 0 7H6" />
                                            </svg>
                                        </span>
                                        <div>
                                            <div class="text-sm font-semibold text-zinc-900">Cash on Delivery</div>
                                            <div class="text-xs text-zinc-500">Pay at doorstep</div>
                                        </div>
                                    </button>
                                </div>

                                <!-- Right content -->
                                <div class="md:col-span-8 p-6 sm:p-8">

                                    <!-- UPI -->
                                    <div id="tabUPI" class="payPanel">
                                        <h2 class="text-lg font-semibold text-zinc-900">Pay with UPI</h2>
                                        <p class="mt-1 text-sm text-zinc-600">Enter your UPI ID and verify to pay.</p>

                                        <form method="POST" action="{% url 'web:payment' %}">
                                        {% csrf_token %}
                                        <div class="mt-5">

                                            <label class="text-xs text-zinc-600">UPI ID *</label>
                                            <input type="text" placeholder="name@bank" id="upiInput" name="upi_id" required
                                                class="mt-1 w-full rounded-2xl border border-line bg-white px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-brownMain/20" />
                                        </div>

                                        <div class="mt-4 flex items-center gap-3">
                                            <input id="saveUpi" type="checkbox" class="accent-brownMain" />
                                            <label for="saveUpi" class="text-sm text-zinc-700">Save this UPI ID for next
                                                time</label>
                                        </div>

                                        <button type="button" id="rzp-button"  disabled
                                            class="mt-6 w-full rounded-2xl bg-brownMain text-white py-3.5 text-sm font-semibold hover:bg-brownDark transition">
                                            Verify & Pay
                                        </button>
                                    </form>
                                        <div class="mt-4 text-xs text-zinc-500">
                                            Tip: Use any UPI app (GPay / PhonePe / Paytm) to approve the collect
                                            request.
                                        </div>
                                    </div>

                                    <!-- Card -->
                                    <div id="tabCard" class="payPanel hidden">
                                        <h2 class="text-lg font-semibold text-zinc-900">Pay with Card</h2>
                                        <p class="mt-1 text-sm text-zinc-600">Add your card details securely.</p>

                                        <div class="mt-5 space-y-4">
                                            <div>
                                                <label class="text-xs text-zinc-600">Card number *</label>
                                                <input type="text" inputmode="numeric" placeholder="1234 5678 9012 3456"
                                                    class="mt-1 w-full rounded-2xl border border-line bg-white px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-brownMain/20" />
                                            </div>

                                            <div class="grid gap-4 sm:grid-cols-2">
                                                <div>
                                                    <label class="text-xs text-zinc-600">Expiry *</label>
                                                    <input type="text" placeholder="MM/YY"
                                                        class="mt-1 w-full rounded-2xl border border-line bg-white px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-brownMain/20" />
                                                </div>
                                                <div>
                                                    <label class="text-xs text-zinc-600">CVV *</label>
                                                    <input type="password" inputmode="numeric" placeholder="***"
                                                        class="mt-1 w-full rounded-2xl border border-line bg-white px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-brownMain/20" />
                                                </div>
                                            </div>

                                            <div>
                                                <label class="text-xs text-zinc-600">Name on card *</label>
                                                <input type="text" placeholder="Full name"
                                                    class="mt-1 w-full rounded-2xl border border-line bg-white px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-brownMain/20" />
                                            </div>

                                            <div class="flex items-center gap-3">
                                                <input id="saveCard" type="checkbox" class="accent-brownMain" />
                                                <label for="saveCard" class="text-sm text-zinc-700">Save card for faster
                                                    checkout</label>
                                            </div>

                                            <button
                                                class="w-full rounded-2xl bg-brownMain text-white py-3.5 text-sm font-semibold hover:bg-brownDark transition">
                                                Pay Now
                                            </button>

                                            <div class="text-xs text-zinc-500">
                                                Your card details are processed securely. We don‚Äôt store CVV.
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Netbanking -->
                                    <div id="tabNetbanking" class="payPanel hidden">
                                        <h2 class="text-lg font-semibold text-zinc-900">Net Banking</h2>
                                        <p class="mt-1 text-sm text-zinc-600">Select your bank to continue.</p>

                                        <div class="mt-5 grid gap-3 sm:grid-cols-2">
                                            <label
                                                class="rounded-2xl border border-line p-4 hover:bg-soft cursor-pointer flex items-center gap-3">
                                                <input type="radio" name="bank" class="accent-brownMain" checked />
                                                <span class="text-sm font-semibold text-zinc-900">HDFC Bank</span>
                                            </label>
                                            <label
                                                class="rounded-2xl border border-line p-4 hover:bg-soft cursor-pointer flex items-center gap-3">
                                                <input type="radio" name="bank" class="accent-brownMain" />
                                                <span class="text-sm font-semibold text-zinc-900">SBI</span>
                                            </label>
                                            <label
                                                class="rounded-2xl border border-line p-4 hover:bg-soft cursor-pointer flex items-center gap-3">
                                                <input type="radio" name="bank" class="accent-brownMain" />
                                                <span class="text-sm font-semibold text-zinc-900">ICICI Bank</span>
                                            </label>
                                            <label
                                                class="rounded-2xl border border-line p-4 hover:bg-soft cursor-pointer flex items-center gap-3">
                                                <input type="radio" name="bank" class="accent-brownMain" />
                                                <span class="text-sm font-semibold text-zinc-900">Axis Bank</span>
                                            </label>
                                        </div>

                                        <div class="mt-5">
                                            <label class="text-xs text-zinc-600">Other banks</label>
                                            <select
                                                class="mt-1 w-full rounded-2xl border border-line bg-white px-4 py-3 text-sm outline-none focus:ring-2 focus:ring-brownMain/20">
                                                <option>Select your bank</option>
                                                <option>Federal Bank</option>
                                                <option>Kotak Mahindra Bank</option>
                                                <option>Canara Bank</option>
                                                <option>Union Bank of India</option>
                                            </select>
                                        </div>

                                        <button
                                            class="mt-6 w-full rounded-2xl bg-brownMain text-white py-3.5 text-sm font-semibold hover:bg-brownDark transition">
                                            Continue to Bank
                                        </button>
                                    </div>

                                    <!-- Wallet -->
                                    <div id="tabWallet" class="payPanel hidden">
                                        <h2 class="text-lg font-semibold text-zinc-900">Wallet</h2>
                                        <p class="mt-1 text-sm text-zinc-600">Choose a wallet to complete payment.</p>

                                        <div class="mt-5 space-y-3">
                                            <label
                                                class="rounded-2xl border border-line p-4 hover:bg-soft cursor-pointer flex items-center justify-between gap-3">
                                                <div class="flex items-center gap-3">
                                                    <input type="radio" name="wallet" class="accent-brownMain"
                                                        checked />
                                                    <span class="text-sm font-semibold text-zinc-900">PhonePe</span>
                                                </div>
                                                <span class="text-xs text-zinc-500">Fast checkout</span>
                                            </label>

                                            <label
                                                class="rounded-2xl border border-line p-4 hover:bg-soft cursor-pointer flex items-center justify-between gap-3">
                                                <div class="flex items-center gap-3">
                                                    <input type="radio" name="wallet" class="accent-brownMain" />
                                                    <span class="text-sm font-semibold text-zinc-900">Paytm</span>
                                                </div>
                                                <span class="text-xs text-zinc-500">Wallet balance</span>
                                            </label>

                                            <label
                                                class="rounded-2xl border border-line p-4 hover:bg-soft cursor-pointer flex items-center justify-between gap-3">
                                                <div class="flex items-center gap-3">
                                                    <input type="radio" name="wallet" class="accent-brownMain" />
                                                    <span class="text-sm font-semibold text-zinc-900">Amazon Pay</span>
                                                </div>
                                                <span class="text-xs text-zinc-500">Quick pay</span>
                                            </label>
                                        </div>

                                        <button
                                            class="mt-6 w-full rounded-2xl bg-brownMain text-white py-3.5 text-sm font-semibold hover:bg-brownDark transition">
                                            Pay with Wallet
                                        </button>
                                    </div>

                                    <!-- COD -->
                                    <div id="tabCOD" class="payPanel hidden">
                                        <h2 class="text-lg font-semibold text-zinc-900">Cash on Delivery</h2>
                                        <p class="mt-1 text-sm text-zinc-600">Pay when your order is delivered.</p>

                                        <div
                                            class="mt-5 rounded-2xl border border-line bg-soft p-4 text-sm text-zinc-700">
                                            <div class="font-semibold text-zinc-900">Important</div>
                                            <ul class="mt-2 space-y-1">
                                                <li>‚Ä¢ Keep the exact amount ready (if possible).</li>
                                                <li>‚Ä¢ COD may be unavailable for some pincodes / order values.</li>
                                            </ul>
                                        </div>

                                        <button
                                            class="mt-6 w-full rounded-2xl bg-brownMain text-white py-3.5 text-sm font-semibold hover:bg-brownDark transition">
                                            Confirm COD Order
                                        </button>
                                    </div>

                                </div>
                            </div>
                        </div>

                        <!-- Security note -->
                        <div class="mt-5 text-xs text-zinc-500 flex items-center gap-2">
                            <svg class="h-4 w-4 text-brownMain" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                                <path d="M9 12l2 2 4-4" />
                            </svg>
                            Payments are secured using encrypted connections. Never share OTPs or passwords.
                        </div>

                    </div>

                    <!-- RIGHT: Order summary -->
                    <aside class="lg:col-span-4 lg:sticky lg:top-24">
                        <div class="rounded-3xl border border-line bg-white overflow-hidden">
                            <div class="px-6 py-5 bg-soft border-b border-line">
                                <h2 class="text-lg font-semibold text-zinc-900">Price details</h2>
                            {% if cart_item_count > 0 %}
                                <p class="text-sm text-zinc-600 mt-1">{{cart_item_count}} items</p>
                            {% endif %}
                            </div>

                            <div class="p-6 space-y-4 text-sm">
                                <div class="flex items-center justify-between text-zinc-700">
                                    <span>Subtotal</span>
                                    <span id="p_subtotal">‚Çπ{{ subtotal }}</span>
                                </div>
                                <div class="flex items-center justify-between text-zinc-700">
                                    <span>Delivery</span>
                                    <span id="p_delivery">‚Çπ{{ delivery_charge }}</span>
                                </div>
                                <div class="flex items-center justify-between text-zinc-700">
                                    <span>Discount</span>
                                    <span id="p_discount">‚Çπ{{ discount }}</span>
                                </div>

                                <div
                                    class="pt-3 border-t border-line flex items-center justify-between text-zinc-900 font-semibold">
                                    <span>Total payable</span>
                                    <span id="p_total">‚Çπ{{ grand_total }}</span>
                                </div>

                                <a href="order-success.html"
                                    class="mt-2 w-full inline-flex items-center justify-center rounded-2xl bg-brownMain text-white py-3.5 text-sm font-semibold hover:bg-brownDark transition">
                                    Continue
                                </a>

                                <div class="text-xs text-zinc-500 leading-relaxed">
                                    Clicking ‚ÄúContinue‚Äù will proceed with the selected payment option.
                                </div>
                            </div>
                        </div>
                    </aside>

                </div>
            </div>
        </div>
    </section>




    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brownMain: '#6B3F2A',
                        brownDark: '#4A2A1C',
                        line: '#E9E2DA',
                        soft: '#FAF8F5',
                    },
                    boxShadow: {
                        soft: '0 12px 35px rgba(0,0,0,0.08)',
                    }
                }
            }
        }
    </script>
    <script src="{% static 'web/js/script.js' %}"></script>
    <script src="{% static 'web/js/payment.js' %}"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>


<script>
const upiInput = document.getElementById("upiInput");
const payBtn = document.getElementById("rzp-button");

// Simple UPI validation
function isValidUPI(upi) {
    const upiRegex = /^[\w.-]+@[\w.-]+$/;
    return upiRegex.test(upi);
}

// Validate input
upiInput.addEventListener("input", function () {
    const upi = upiInput.value.trim();

    if (!upi || !isValidUPI(upi)) {
        upiInput.classList.remove("border-line");
        upiInput.classList.add("border-red-500");

        payBtn.disabled = true;
        payBtn.classList.add("bg-gray-400", "cursor-not-allowed");
        payBtn.classList.remove("bg-brownMain", "hover:bg-brownDark");
    } else {
        upiInput.classList.remove("border-red-500");
        upiInput.classList.add("border-line");

        payBtn.disabled = false;
        payBtn.classList.remove("bg-gray-400", "cursor-not-allowed");
        payBtn.classList.add("bg-brownMain", "hover:bg-brownDark");
    }
});
</script>



<script>
document.getElementById('rzp-button').onclick = function (e) {
    e.preventDefault();

    const upi = document.getElementById("upiInput").value.trim();

    if (!upi) {
        upiInput.classList.add("border-red-500");
        return;
    }

    var options = {
        "key": "rzp_test_RyxeVLDfJCnM69",
        "amount": "{{ grand_total|floatformat:2|add:'0' }}".replace('.', ''),
        "currency": "INR",
        "name": "Kanthi Mantra",
        "description": "Order Payment",
        "image": "/static/web/images/logo.png",

        // üëá FORCE UPI (GPay / PhonePe / Paytm)
        "method": {
            "upi": true
        },

        "upi": {
            "vpa": upi
        },

        "handler": function (response) {
            fetch("{% url 'web:payment_success' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    razorpay_payment_id: response.razorpay_payment_id
                })
            }).then(() => {
                window.location.href = "{% url 'web:order_success' %}";
            });
        },

        "prefill": {
            "email": "{{ request.user.email }}",
            "contact": "{{ request.user.phone_number }}"
        },

        "theme": {
            "color": "#6B3F2A"
        }
    };

    var rzp1 = new Razorpay(options);
    rzp1.open();
};
</script>



{% endblock %}